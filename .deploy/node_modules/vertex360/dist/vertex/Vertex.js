"use strict";var _prototypeProperties=function(t,e,r){e&&Object.defineProperties(t,e),r&&Object.defineProperties(t.prototype,r)},_classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},formatCallback=require("./callback"),Router=require("./Router"),db=require("./db"),Vertex=function(){function t(e){if(_classCallCheck(this,t),this.routes=[],this.staticDir="public",this.opts=e,null!=e){this.staticDir=e.static||"public";var r=e.db;null!=r&&(null==r.type?db.connect(r.url,r.onError):(r.type,db.connectMongo(r.url,r.onError)))}}return _prototypeProperties(t,null,{expressVersion:{value:function(t){var e=this;return t.use("/turbo",function(t,r,o){r.json({confirmation:"success",data:JSON.stringify(e.routes)})}),e.routes.forEach(function(e){t.use(e.stem,function(t,r,o){r.json({confirmation:"success",data:e.stem})})}),t},writable:!0,configurable:!0},useStatic:{value:function(t){this.staticDir=t},writable:!0,configurable:!0},use:{value:function(t,e){e.setStem(t),this.routes.push(e)},writable:!0,configurable:!0},get:{value:function(t,e){var r=new Router;r.setStem("/"),r.get(t,e),this.routes.push(r)},writable:!0,configurable:!0},post:{value:function(t,e){var r=new Router;r.setStem("/"),r.post(t,e),this.routes.push(r)},writable:!0,configurable:!0},routeNotFound:{value:function(t,e){t.httpMethod.toLowerCase();return{isBase64Encoded:!1,statusCode:501,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",message:e})}},writable:!0,configurable:!0},handle:{value:function(t){var e=t.event,r=t.callback,o=e.httpMethod.toLowerCase();if("post"==o){for(var n=null,a=0;a<this.routes.length;a++){var i=this.routes[a];if(null!=i.handlePost(e)){n=i.handlePost(e);break}}if(null==n)return void r(null,this.routeNotFound(e,o+" route not defined for this path: "+e.path));var s=formatCallback(e,r,n.routeParams,this.opts);return void n.routeHandler(s.req,s.res)}if("put"==o){for(var n=null,a=0;a<this.routes.length;a++){var i=this.routes[a];if(null!=i.handlePut(e)){n=i.handlePut(e);break}}if(null==n)return void r(null,this.routeNotFound(e,o+" route not defined for this path: "+e.path));var s=formatCallback(e,r,n.routeParams,this.opts);return void n.routeHandler(s.req,s.res)}if("delete"==o){for(var n=null,a=0;a<this.routes.length;a++){var i=this.routes[a];if(null!=i.handleDelete(e)){n=i.handleDelete(e);break}}if(null==n)return void r(null,this.routeNotFound(e,o+" route not defined for this path: "+e.path));var s=formatCallback(e,r,n.routeParams,this.opts);return void n.routeHandler(s.req,s.res)}if("get"==o){if(-1==e.path.indexOf(".")){for(var n=null,a=0;a<this.routes.length;a++){var i=this.routes[a];if(null!=i.handleGet(e)){n=i.handleGet(e);break}}if(null==n)return void r(null,this.routeNotFound(e,o+" route not defined for this path: "+e.path));var s=formatCallback(e,r,n.routeParams,this.opts);return void n.routeHandler(s.req,s.res)}if(void 0==e.headers||null==e.headers)return void r(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header (headers is null)"})});var u=e.headers["Turbo-Vertex-App"];if(null==u)return void r(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header"})});r(null,{isBase64Encoded:!1,statusCode:301,headers:{Location:"https://"+("cdn.turbo360-vertex.com/"+u+"/"+(this.staticDir||"public")+e.path).replace("//","/")},body:""})}},writable:!0,configurable:!0}}),t}();module.exports=Vertex;